box: wercker/nodejs
build:
  steps:
    - npm-install
    - script:
        name: Install grunt
        code: sudo npm install -g grunt-cli
    - script:
        name: Build and Cache Assets
        code: |
          make build
          rsync -avzv "$WERCKER_SOURCE_DIR/public" "$WERCKER_CACHE_DIR/$WERCKER_GIT_COMMIT/"
    - npm-test

deploy:
  steps:
    - script:
        name: Install grunt
        code: sudo npm install -g grunt-cli
    - npm-install
    - script:
        name: Build assets
        code: |
          if test -d "$WERCKER_CACHE_DIR/$WERCKER_GIT_COMMIT"; then rsync -avzv "$WERCKER_CACHE_DIR/$WERCKER_GIT_COMMIT/" "$WERCKER_SOURCE_DIR/public/" ; else make build ; fi
    - analogj/git-configure@0.0.3
    - script:
        name: Commit Assets
        code: |
          git config --global user.email "sam@quickleft.com.com"
          git config --global user.name "Wercker Bot"
          git add .
          git commit -am 'asset compile'
    - heroku-deploy:
        key-name: heroku-production
